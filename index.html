<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Playlist Downloader - Saavn Only</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
:root{
  --bg:#121212;
  --surface:#1e1e1e;
  --surface2:#242424;
  --surfaceActive:#221a3d;
  --text:#fff;
  --sub:#b3b3b3;
  --accent:#7C4DFF;
}
*{box-sizing:border-box}
body{margin:0;font-family:'Varela Round',system-ui;background:var(--bg);color:var(--text)}
.container{max-width:900px;margin:auto;padding:20px 20px 180px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.header-title{font-size:24px;font-weight:bold}
.header-sub{font-size:14px;color:var(--sub)}
.quality-selector button{margin-left:5px;padding:5px 10px;background:var(--surface2);color:var(--text);border:none;border-radius:4px;cursor:pointer}
.quality-selector button.active{background:var(--accent)}
.list{display:flex;flex-direction:column;gap:10px}
.card{display:flex;align-items:center;background:var(--surface2);padding:10px;border-radius:8px;position:relative}
.card img{width:50px;height:50px;border-radius:4px;margin-right:10px}
.card-info{flex:1}
.card .play-wrap,.card .download-wrap{cursor:pointer;margin-left:10px}
.material-icons{vertical-align:middle}
.download-all{position:fixed;bottom:80px;right:20px;padding:15px;border:none;border-radius:50%;background:var(--accent);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center}
.fab{position:fixed;bottom:20px;right:20px;padding:15px;border:none;border-radius:50%;background:var(--accent);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center}
.sheet{position:fixed;bottom:-100%;left:0;width:100%;background:var(--surface);padding:20px;transition:0.3s}
.sheet.open{bottom:0}
.progress-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center}
.progress-modal.show{display:flex}
.progress-content{background:var(--surface2);padding:20px;border-radius:8px;width:300px;text-align:center}
.progress-bar-container{background:var(--surface);height:10px;width:100%;border-radius:5px;margin:10px 0}
.progress-bar{height:10px;background:var(--accent);width:0;border-radius:5px}
.cancel-btn{margin-top:10px;padding:5px 10px;background:red;border:none;color:#fff;border-radius:4px;cursor:pointer}
</style>
</head>

<body>

<div class="container">
  <div class="header">
    <div>
      <div class="header-title">Playlist Downloader</div>
      <div class="header-sub" id="trackCount">No playlist loaded</div>
    </div>
    <div class="selectors">
      <span>Quality:</span>
      <div class="quality-selector">
        <button class="quality-btn" data-quality="96kbps">96</button>
        <button class="quality-btn active" data-quality="160kbps">160</button>
        <button class="quality-btn" data-quality="320kbps">320</button>
      </div>
    </div>
  </div>

  <div class="list" id="tracks"></div>
</div>

<button class="download-all" id="downloadAll">
  <span class="material-icons">download</span>
</button>

<button class="fab" id="fab">+</button>

<div class="sheet" id="sheet">
  <input id="playlistUrl" placeholder="Paste Spotify playlist URL">
  <button id="loadBtn">Load</button>
</div>

<div class="progress-modal" id="progressModal">
  <div class="progress-content">
    <div class="progress-title" id="progressTitle">Downloading Songs...</div>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="progress-text" id="progressText">0 / 0</div>
    <button class="cancel-btn" id="cancelDownload">Cancel</button>
  </div>
</div>

<audio id="player"></audio>

<script>
/* ================= CONFIG ================= */
const SPOTIFY_API = "https://spotify-api-6yog.vercel.app/api/scrape";
const SAAVN_API = "https://jiosavan-api-with-playlist.vercel.app/api/search/songs";

/* ================= DOM ================= */
const tracksDiv = document.getElementById("tracks");
const trackCount = document.getElementById("trackCount");
const player = document.getElementById("player");
const downloadBtn = document.getElementById("downloadAll");
const progressModal = document.getElementById("progressModal");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");
const progressTitle = document.getElementById("progressTitle");
const fab = document.getElementById("fab");
const sheet = document.getElementById("sheet");
const loadBtn = document.getElementById("loadBtn");
const playlistUrl = document.getElementById("playlistUrl");
const cancelDownloadBtn = document.getElementById("cancelDownload");

/* ================= STATE ================= */
let currentSongKey = null;
let currentCard = null;
let selectedQuality = "160kbps";
let saavnCache = {};
let downloading = false;
let cancelDownloadFlag = false;

/* ================= QUALITY ================= */
document.querySelectorAll(".quality-btn").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".quality-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    selectedQuality=btn.dataset.quality;
  };
});

/* ================= FAB ================= */
fab.onclick=()=>sheet.classList.add("open");

/* ================= HELPERS ================= */
function getPlaylistId(url){
  try{
    const u=new URL(url);
    return u.pathname.split("/playlist/")[1]?.split("/")[0];
  }catch{return null;}
}

async function prefetchAudio(key){
  try{
    const res = await fetch(`${SAAVN_API}?query=${encodeURIComponent(key)}&limit=1`);
    const json = await res.json();
    saavnCache[key] = json?.data?.results?.filter(r=>r.format==="mp3")||[];
  }catch(err){
    console.warn("Error fetching audio:", key, err);
    saavnCache[key] = [];
  }
}

function getBestAudio(urls, preferred){
  if(!Array.isArray(urls)) return null;
  const order = ["96kbps","160kbps","320kbps"];
  const sorted = urls.filter(u=>u.quality && order.includes(u.quality))
                     .sort((a,b)=>order.indexOf(b.quality)-order.indexOf(a.quality));
  return sorted.find(u=>u.quality===preferred) || sorted[0] || null;
}

/* ================= LOAD PLAYLIST ================= */
loadBtn.onclick = async () => {
  const id = getPlaylistId(playlistUrl.value.trim());
  if(!id) return;
  sheet.classList.remove("open");
  tracksDiv.innerHTML="";
  downloadBtn.style.display="none";
  saavnCache={};

  const res = await fetch(`${SPOTIFY_API}?playlist=${id}`);
  const data = await res.json();
  const tracks = data.tracks.filter(t=>t.title && t.artists);
  trackCount.textContent=`${tracks.length} tracks`;

  // Sequential prefetch to prevent freezing
  for(const t of tracks){
    await prefetchAudio(`${t.title} ${t.artists}`);
  }

  downloadBtn.style.display="flex";

  tracks.forEach(t=>{
    const key = `${t.title} ${t.artists}`;
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.key = key;
    card.innerHTML=`
      <img src="${t.image}">
      <div class="card-info">
        <div class="title">${t.title}</div>
        <div class="meta">${t.artists}</div>
      </div>
      <div class="play-wrap"><span class="material-icons">play_arrow</span></div>
      <div class="download-wrap"><span class="material-icons">file_download</span></div>
    `;
    const playBtn = card.querySelector(".play-wrap");
    const icon = playBtn.querySelector(".material-icons");
    const downloadSongBtn = card.querySelector(".download-wrap");

    playBtn.onclick=()=>{
      const best=getBestAudio(saavnCache[key],selectedQuality);
      if(!best) return;
      if(currentCard){currentCard.classList.remove("playing");currentCard.querySelector(".material-icons").textContent="play_arrow";}
      player.src = best.url;
      player.play();
      icon.textContent = "pause";
      card.classList.add("playing");
      currentCard = card;
      currentSongKey = key;
    };

    downloadSongBtn.onclick=async()=>{
      await downloadSongs([{key,urlList:saavnCache[key]}]);
    };

    tracksDiv.appendChild(card);
  });
};

/* ================= DOWNLOAD SONGS ================= */
async function downloadSongs(songList){
  downloading = true;
  cancelDownloadFlag = false;
  progressModal.classList.add("show");
  let done = 0;
  const total = songList.length;
  progressBar.style.width="0%";
  progressText.textContent=`0 / ${total}`;
  progressTitle.textContent="Downloading Songs...";

  for(const s of songList){
    if(cancelDownloadFlag) break;
    const best = getBestAudio(s.urlList, selectedQuality);
    if(!best){done++; continue;}
    progressTitle.textContent=`Downloading: ${s.key} (${best.quality} MP3)`;

    try{
      const res = await fetch(best.url);
      const blob = await res.blob();
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${s.key.replace(/[<>:"/\\|?*]/g,"_")}.mp3`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }catch(err){
      console.warn("Download failed:", s.key, err);
    }

    done++;
    progressBar.style.width=`${(done/total)*100}%`;
    progressText.textContent=`${done} / ${total}`;
    await new Promise(r=>setTimeout(r,50)); // short delay for responsiveness
  }

  progressTitle.textContent = cancelDownloadFlag?"Download Cancelled!":"Download Complete!";
  downloading = false;
}

downloadBtn.onclick=async()=>{
  const songs = Object.entries(saavnCache).map(([key,urlList])=>({key,urlList}));
  await downloadSongs(songs);
};

cancelDownloadBtn.onclick=()=>{cancelDownloadFlag=true;}
</script>

</body>
</html>
