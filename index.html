<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Playlist Downloader</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
body{margin:0;font-family:'Varela Round',system-ui;background:#121212;color:#fff}
.container{max-width:900px;margin:auto;padding:20px 20px 180px}
.header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
.header-title{font-size:2rem;color:#7C4DFF;font-weight:bold}
.header-sub{font-size:.9rem;color:#aaa;margin-top:5px}
.search{width:100%;padding:10px;margin:15px 0;border-radius:25px;border:1px solid #333;background:#1e1e1e;color:#fff;font-size:1rem}

.loader{display:none;margin:20px auto;width:40px;height:40px;border:4px solid #333;border-top:4px solid #7C4DFF;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

.card{display:flex;gap:12px;padding:12px;background:#242424;border-radius:14px;margin-bottom:12px;align-items:center;transition:.3s;cursor:pointer}
.card:hover{background:#2b2b2b}
.card.playing{outline:2px solid #7C4DFF}

.card img{width:60px;height:60px;border-radius:12px;object-fit:cover}
.card-info{flex:1;overflow:hidden}
.title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:bold}
.title mark{background:yellow;color:#000;padding:0 2px;border-radius:2px;}
.meta{font-size:.8rem;color:#aaa}
.actions{display:flex;gap:10px}
.actions span{cursor:pointer;color:#7C4DFF}

.quality-btn{background:#222;border:1px solid #444;color:#bbb;padding:6px 14px;border-radius:20px;cursor:pointer}
.quality-btn.active{border-color:#7C4DFF;color:#7C4DFF}

.fab,.download-all{position:fixed;right:20px;width:56px;height:56px;border-radius:50%;background:linear-gradient(45deg,#7C4DFF,#9a6bff);border:none;color:#fff;font-size:28px;cursor:pointer}
.fab{bottom:20px}
.download-all{bottom:90px;display:none}

.sheet{position:fixed;bottom:0;left:0;width:100%;background:#1e1e1e;padding:25px;transform:translateY(100%);transition:.3s;border-radius:20px 20px 0 0}
.sheet.open{transform:translateY(0)}
.sheet input,.sheet button{width:100%;padding:12px;border-radius:25px;border:none;margin-bottom:10px}

.progress{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center}
.progress.show{display:flex}
.box{background:#222;padding:20px;border-radius:20px;width:300px;text-align:center}
.bar{height:10px;background:#333;border-radius:6px;overflow:hidden}
.bar div{height:100%;width:0;background:linear-gradient(90deg,#7C4DFF,#9a6bff)}

.skeleton{display:flex;gap:12px;padding:12px;background:#1e1e1e;border-radius:14px;margin-bottom:12px;align-items:center;animation:shimmer 1.2s infinite linear}
.skeleton .img{width:60px;height:60px;background:#333;border-radius:12px}
.skeleton .info{flex:1;display:flex;flex-direction:column;gap:8px}
.skeleton .line{height:14px;background:#333;border-radius:6px;width:80%}
.skeleton .line.short{width:50%}
@keyframes shimmer{
  0%{background-position:-200px 0}
  100%{background-position:200px 0}
}
</style>
</head>

<body>

<div class="container">
  <div class="header">
    <div>
      <div class="header-title">Playlist Downloader</div>
      <div class="header-sub" id="trackCount">No playlist loaded</div>
    </div>
    <div>
      <button class="quality-btn active" data-q="320kbps">320</button>
      <button class="quality-btn" data-q="160kbps">160</button>
      <button class="quality-btn" data-q="96kbps">96</button>
    </div>
  </div>

  <input class="search" id="search" placeholder="Search by song title">
  <div class="loader" id="loader"></div>
  <div id="tracks"></div>
</div>

<button class="download-all" id="downloadAll">â¬‡</button>
<button class="fab" id="fab">+</button>

<div class="sheet" id="sheet">
  <input id="playlistUrl" placeholder="Spotify playlist URL">
  <button id="loadBtn">Load Playlist</button>
</div>

<div class="progress" id="progress">
  <div class="box">
    <b id="pText">0 / 0</b>
    <div class="bar"><div id="pBar"></div></div>
  </div>
</div>

<audio id="player"></audio>

<script>
const SPOTIFY_API="https://spotify-api-6yog.vercel.app/api/scrape";
const SAAVN_API="https://jiosavan-api-with-playlist.vercel.app/api/search/songs";

const tracksDiv=document.getElementById("tracks");
const loader=document.getElementById("loader");
const player=document.getElementById("player");
const searchInput=document.getElementById("search");
const downloadAllBtn=document.getElementById("downloadAll");
const progress=document.getElementById("progress");
const pBar=document.getElementById("pBar");
const pText=document.getElementById("pText");

let quality="320kbps";
let saavnCache={};
let currentKey=null,currentBtn=null,currentCard=null;

// Quality buttons
document.querySelectorAll(".quality-btn").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".quality-btn").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    quality=b.dataset.q;
  };
});

// FAB
const fab=document.getElementById("fab");
const sheet=document.getElementById("sheet");
fab.onclick=()=>sheet.classList.add("open");

// Playlist ID parser
function getPlaylistId(url){
    try{
        const u=new URL(url);
        const parts=u.pathname.split('/');
        const idx=parts.indexOf('playlist');
        if(idx!==-1 && parts[idx+1]) return parts[idx+1];
        return null;
    }catch{return null;}
}

// Skeleton cards
function showSkeletons(count){
  tracksDiv.innerHTML="";
  for(let i=0;i<count;i++){
    const s=document.createElement("div");
    s.className="skeleton";
    s.innerHTML=`<div class="img"></div><div class="info"><div class="line"></div><div class="line short"></div></div>`;
    tracksDiv.appendChild(s);
  }
}

// Highlight search term
function highlight(text, term){
  if(!term) return text;
  const re=new RegExp(`(${term})`,"gi");
  return text.replace(re,"<mark>$1</mark>");
}

// Prefetch Saavn
async function prefetch(key){
  if(saavnCache[key]) return;
  try{
    const res=await fetch(`${SAAVN_API}?query=${encodeURIComponent(key)}&limit=1`);
    const j=await res.json();
    saavnCache[key]=j?.data?.results?.[0]?.downloadUrl||[];
  }catch{ saavnCache[key]=[]; }
}

// Get best quality
function getBest(urls){if(!urls)return null;return urls.find(u=>u.quality===quality)||urls[0];}

// Load playlist
document.getElementById("loadBtn").onclick=async()=>{
  const url=document.getElementById("playlistUrl").value.trim();
  const id=getPlaylistId(url);
  if(!id){alert("Invalid playlist URL"); return;}
  sheet.classList.remove("open");

  loader.style.display="block";
  showSkeletons(5);

  try{
    const res=await fetch(`${SPOTIFY_API}?playlist=${id}`);
    if(!res.ok)throw new Error("Failed to fetch playlist");
    const j=await res.json();
    if(!j.tracks || !Array.isArray(j.tracks))throw new Error("No tracks found");
    document.getElementById("trackCount").textContent=j.tracks.length+" tracks";

    tracksDiv.innerHTML="";
    for(const t of j.tracks){
      const key=`${t.title} ${t.artists}`;
      await prefetch(key);

      const c=document.createElement("div");
      c.className="card";
      c.dataset.search=t.title.toLowerCase();
      c.innerHTML=`<img src="${t.image}">
        <div class="card-info">
          <div class="title">${t.title}</div>
          <div class="meta">${t.artists}</div>
        </div>
        <div class="actions">
          <span class="material-icons play">play_arrow</span>
          <span class="material-icons down">download</span>
        </div>`;
      tracksDiv.appendChild(c);

      // Play button
      c.querySelector(".play").onclick=()=>{
        const best=getBest(saavnCache[key]);
        if(!best)return;

        if(currentKey===key){
          if(player.paused){player.play(); c.querySelector(".play").textContent="pause";}
          else{player.pause(); c.querySelector(".play").textContent="play_arrow";}
          return;
        }
        if(currentBtn)currentBtn.textContent="play_arrow";
        if(currentCard)currentCard.classList.remove("playing");

        player.src=best.url;
        player.play();
        c.querySelector(".play").textContent="pause";
        c.classList.add("playing");

        currentKey=key; currentBtn=c.querySelector(".play"); currentCard=c;
      };

      // Download button
      c.querySelector(".down").onclick=async()=>{
        const best=getBest(saavnCache[key]); if(!best)return;
        const b=await (await fetch(best.url)).blob();
        const a=document.createElement("a");
        a.href=URL.createObjectURL(b);
        a.download=`${key.replace(/[<>:"/\\|?*]/g,"_")}.m4a`;
        a.click();
      };
    }

    downloadAllBtn.style.display="block";
  }catch(e){alert("Error loading playlist: "+e.message);}
  loader.style.display="none";
};

// Audio end event
player.onended=()=>{if(currentBtn)currentBtn.textContent="play_arrow"; if(currentCard)currentCard.classList.remove("playing"); currentKey=null; currentBtn=null;};

// Search input
searchInput.oninput=e=>{
  const q=e.target.value.toLowerCase().trim();
  document.querySelectorAll(".card").forEach(c=>{
    const title=c.querySelector(".title").textContent;
    if(title.toLowerCase().includes(q)){
      c.style.display="flex";
      c.querySelector(".title").innerHTML=highlight(title,q);
    }else c.style.display="none";
  });
};

// Download all
downloadAllBtn.onclick=async()=>{
  const entries=Object.entries(saavnCache);
  progress.classList.add("show");

  for(let i=0;i<entries.length;i++){
    const [k,u]=entries[i];
    const best=getBest(u); if(!best) continue;
    const b=await (await fetch(best.url)).blob();
    const a=document.createElement("a");
    a.href=URL.createObjectURL(b);
    a.download=`${k.replace(/[<>:"/\\|?*]/g,"_")}.m4a`;
    a.click();

    pText.textContent=`${i+1} / ${entries.length}`;
    pBar.style.width=((i+1)/entries.length*100)+"%";
    await new Promise(r=>setTimeout(r,700));
  }
  progress.classList.remove("show");
};
</script>
</body>
</html>
